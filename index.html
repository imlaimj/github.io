<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ²¡å¤´è„‘ç”Ÿæˆå™¨</title>
    <!-- å¼•å…¥ Noto Sans HK (Regular 400)ï¼Œé£æ ¼æ¸…çˆ½ä¸”ç²—ç»†é€‚ä¸­ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@400&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans HK', sans-serif;
            font-weight: 400;
        }
        
        #fileInput {
            display: none;
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        canvas {
            image-rendering: -webkit-optimize-contrast;
            max-width: 100%;
            height: auto;
            cursor: pointer;
            border-radius: 12px;
        }
        
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center py-6">

    <h1 class="text-xl font-bold text-gray-300 mb-4 tracking-widest">æ²¡å¤´è„‘ç”Ÿæˆå™¨</h1>

    <!-- 1. è¡¨æƒ…åŒ…é¢„è§ˆåŒºåŸŸ (Canvas) -->
    <div class="relative w-11/12 max-w-sm bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200" id="canvasContainer">
        <div id="loading" class="loading-overlay">
            <span class="text-sm text-gray-400 animate-pulse">æ­£åœ¨è½½å…¥åº•å›¾...</span>
        </div>
        <canvas id="memeCanvas" class="w-full h-auto block bg-white" title="ç‚¹å‡»æ‰‹åŠ¨åŠ è½½åº•å›¾"></canvas>
    </div>

    <!-- 2. æ§åˆ¶åŒºåŸŸ -->
    <div class="w-11/12 max-w-sm mt-6 space-y-4">
        
        <!-- æ–‡æœ¬è¾“å…¥ -->
        <div class="relative">
            <input type="text" id="textInput" maxlength="2" placeholder="è¾“å…¥2ä¸ªæ±‰å­—" 
                class="w-full h-14 text-center text-2xl border border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 outline-none transition bg-white shadow-inner placeholder-gray-300">
        </div>

        <!-- ä¿å­˜æŒ‰é’® -->
        <button id="saveBtn" class="w-full py-4 bg-blue-600 text-white text-lg font-bold rounded-xl shadow-md active:scale-95 transition transform flex items-center justify-center gap-2">
            ä¿å­˜åˆ°æœ¬åœ°
        </button>

        <!-- é«˜çº§è°ƒæ•´ -->
        <details class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
            <summary class="text-sm text-gray-400 font-medium cursor-pointer list-none flex justify-between items-center">
                <span>ğŸ› ï¸ ç²¾ç»†è°ƒèŠ‚</span>
                <span class="text-gray-300">â–¼</span>
            </summary>
            <div class="mt-4 space-y-5">
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-xs text-gray-500">å­—ä½“å¤§å°</span>
                        <span id="fontSizeVal" class="text-xs text-blue-600 font-mono">128px</span>
                    </div>
                    <input type="range" id="fontSizeRange" min="20" max="300" value="128" class="w-full h-1.5 bg-gray-100 rounded-lg appearance-none cursor-pointer accent-blue-600">
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-xs text-gray-500">å‚ç›´ä½ç½® (Yè½´)</span>
                        <span id="textYVal" class="text-xs text-blue-600 font-mono">40%</span>
                    </div>
                    <input type="range" id="textYRange" min="0" max="100" value="40" class="w-full h-1.5 bg-gray-100 rounded-lg appearance-none cursor-pointer accent-blue-600">
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-xs text-gray-500">å­—é—´è·è¡¥å¿</span>
                        <span id="letterSpacingVal" class="text-xs text-blue-600 font-mono">20px</span>
                    </div>
                     <input type="range" id="letterSpacingRange" min="-50" max="200" value="20" class="w-full h-1.5 bg-gray-100 rounded-lg appearance-none cursor-pointer accent-blue-600">
                </div>
                <div class="pt-2 border-t border-gray-50 text-center">
                    <button id="changeTemplateBtn" class="text-xs text-gray-400 underline">æ‰‹åŠ¨æ›¿æ¢å…¶ä»–åº•å›¾</button>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
            </div>
        </details>
    </div>

    <script>
        const canvas = document.getElementById('memeCanvas');
        const ctx = canvas.getContext('2d');
        const input = document.getElementById('textInput');
        const saveBtn = document.getElementById('saveBtn');
        const fileInput = document.getElementById('fileInput');
        const changeTemplateBtn = document.getElementById('changeTemplateBtn');
        const loadingOverlay = document.getElementById('loading');
        
        const fontSizeRange = document.getElementById('fontSizeRange');
        const textYRange = document.getElementById('textYRange');
        const letterSpacingRange = document.getElementById('letterSpacingRange');
        
        let bgImage = new Image();
        let isImageLoaded = false;
        
        const STATE = {
            text: '',
            fontSize: 128,
            textYPercent: 0.40,
            letterSpacing: 20
        };

        function init() {
            const templatePath = 'template.jpg';
            
            bgImage.onload = () => {
                isImageLoaded = true;
                loadingOverlay.style.display = 'none';
                canvas.width = bgImage.naturalWidth;
                canvas.height = bgImage.naturalHeight;
                draw();
            };

            bgImage.onerror = () => {
                loadingOverlay.style.display = 'none';
                isImageLoaded = true;
                canvas.width = 600;
                canvas.height = 600;
                drawPlaceholder("æœªæ‰¾åˆ° template.jpgï¼Œç‚¹å‡»ä¸Šä¼ åº•å›¾");
            };

            bgImage.src = templatePath; 

            canvas.addEventListener('click', () => fileInput.click());
            changeTemplateBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleImageUpload);
            
            input.addEventListener('input', (e) => {
                STATE.text = e.target.value;
                draw();
            });
            
            saveBtn.addEventListener('click', saveImage);
            
            bindRangeInput(fontSizeRange, 'fontSize', 'fontSizeVal', 'px');
            bindRangeInput(textYRange, 'textYPercent', 'textYVal', '%', val => val / 100);
            bindRangeInput(letterSpacingRange, 'letterSpacing', 'letterSpacingVal', 'px');

            document.fonts.ready.then(() => draw());
        }

        function drawPlaceholder(msg = "ç‚¹å‡»æ­¤å¤„ï¼Œæ‰‹åŠ¨é€‰æ‹©å›¾ç‰‡") {
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = "#E5E7EB";
            ctx.setLineDash([8, 8]);
            ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
            ctx.setLineDash([]);
            
            ctx.font = "400 16px 'Noto Sans HK', sans-serif";
            ctx.fillStyle = "#6B7280";
            ctx.textAlign = "center";
            ctx.fillText(msg, canvas.width / 2, canvas.height / 2);
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const newImg = new Image();
                newImg.onload = () => {
                    bgImage = newImg;
                    isImageLoaded = true;
                    canvas.width = bgImage.naturalWidth;
                    canvas.height = bgImage.naturalHeight;
                    draw();
                };
                newImg.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function draw() {
            if (!isImageLoaded) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (bgImage.complete && bgImage.naturalWidth !== 0) {
                ctx.drawImage(bgImage, 0, 0);
            }

            if (STATE.text) {
                ctx.font = `400 ${STATE.fontSize}px 'Noto Sans HK', sans-serif`;
                ctx.fillStyle = '#000000';
                ctx.textBaseline = 'middle';
                ctx.textAlign = 'center';

                const centerX = canvas.width / 2;
                const posY = canvas.height * STATE.textYPercent;
                
                if (STATE.text.length > 1) {
                    const char1 = STATE.text[0];
                    const char2 = STATE.text[1];
                    const offset = (STATE.fontSize / 2) + STATE.letterSpacing;
                    ctx.fillText(char1, centerX - offset, posY);
                    ctx.fillText(char2, centerX + offset, posY);
                } else {
                    ctx.fillText(STATE.text, centerX, posY);
                }
            }
        }

        function saveImage() {
            try {
                const dataURL = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `è¡¨æƒ…åŒ…_${STATE.text || 'result'}.png`;
                link.href = dataURL;
                link.click();
            } catch (e) {
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-black/80 flex flex-col items-center justify-center z-50 p-6";
                modal.innerHTML = `
                    <p class="text-white mb-4 text-center">ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ— æ³•ç›´æ¥ä¿å­˜ã€‚<br>è¯·é•¿æŒ‰ä¸‹æ–¹å›¾ç‰‡é€‰æ‹©â€œä¿å­˜å›¾ç‰‡â€ï¼š</p>
                    <img src="${canvas.toDataURL('image/png')}" class="max-w-full rounded-lg shadow-xl">
                    <button class="mt-6 px-6 py-2 bg-white rounded-full font-bold" onclick="this.parentElement.remove()">å…³é—­</button>
                `;
                document.body.appendChild(modal);
            }
        }

        function bindRangeInput(el, stateKey, displayId, suffix, transformFn = v => Number(v)) {
            el.addEventListener('input', (e) => {
                const val = transformFn(e.target.value);
                STATE[stateKey] = val;
                document.getElementById(displayId).innerText = e.target.value + suffix;
                draw();
            });
        }

        init();
    </script>
</body>
</html>
